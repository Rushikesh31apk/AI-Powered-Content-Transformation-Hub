<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech to Text - AI Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            background:#121212; color:#f0f0f0; min-height:100vh;
        }

        /* ─── NAVBAR ─── */
        .top-navbar {
            position:fixed; top:0; left:0; width:100%; z-index:1000;
            background:rgba(18,18,18,0.95); backdrop-filter:blur(12px);
            border-bottom:2px solid #FFC107;
            padding:14px 32px; display:flex; align-items:center;
            justify-content:space-between; transition:padding .3s;
            box-shadow:0 4px 20px rgba(0,0,0,.4);
        }
        .top-navbar.scrolled { padding:10px 32px; }
        .nb-left { display:flex; align-items:center; gap:12px; }
        .nb-logo {
            width:42px; height:42px;
            background:linear-gradient(135deg,#FFC107,#FF9800);
            border-radius:50%; display:flex; align-items:center; justify-content:center;
            font-size:18px; color:#121212; font-weight:800;
            box-shadow:0 4px 12px rgba(255,193,7,.3);
        }
        .nb-brand { font-size:22px; font-weight:800; background:linear-gradient(to right,#FFC107,#FF9800); -webkit-background-clip:text; background-clip:text; color:transparent; }
        .nb-links { display:flex; gap:6px; }
        .nb-links a {
            color:#aaa; text-decoration:none; font-size:14px; font-weight:600;
            padding:8px 14px; border-radius:8px; transition:all .25s;
        }
        .nb-links a:hover, .nb-links a.active { color:#121212; background:#FFC107; }
        .nb-right { display:flex; align-items:center; gap:16px; }
        .nb-profile { display:flex; align-items:center; gap:10px; cursor:pointer; }
        .nb-avatar {
            width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg,#FFC107,#FF9800);
            display:flex; align-items:center; justify-content:center; font-size:16px; color:#121212; font-weight:700;
            border:2px solid #333; overflow:hidden;
        }
        .nb-user-info { text-align:left; }
        .nb-user-name { font-size:13px; font-weight:700; color:#fff; }
        .nb-user-role { font-size:11px; color:#FFC107; }

        /* ─── PAGE LAYOUT ─── */
        .page-wrap { padding-top:84px; min-height:100vh; display:flex; flex-direction:column; }

        /* ─── HERO HEADER ─── */
        .page-hero {
            background:linear-gradient(135deg, #1a1a1a 0%, #222 100%);
            border-bottom:1px solid #2a2a2a;
            padding:36px 32px 32px; text-align:center; position:relative; overflow:hidden;
        }
        .page-hero::before {
            content:''; position:absolute; bottom:-60px; right:-60px;
            width:200px; height:200px; border-radius:50%;
            background:radial-gradient(circle, rgba(255,193,7,.08) 0%, transparent 70%);
        }
        .hero-icon-wrap {
            width:68px; height:68px; border-radius:18px; margin:0 auto 18px;
            background:linear-gradient(135deg,rgba(255,193,7,.15),rgba(255,152,0,.15));
            border:1px solid rgba(255,193,7,.3);
            display:flex; align-items:center; justify-content:center;
            font-size:28px; color:#FFC107; position:relative; z-index:1;
        }
        .page-hero h1 { font-size:1.9rem; font-weight:800; color:#fff; position:relative; z-index:1; margin-bottom:6px; }
        .page-hero h1 span { background:linear-gradient(135deg,#FFC107,#FF9800); -webkit-background-clip:text; background-clip:text; color:transparent; }
        .page-hero p { color:#888; font-size:.92rem; position:relative; z-index:1; max-width:520px; margin:0 auto; }

        /* ─── MAIN CONTENT ─── */
        .main-content { flex:1; padding:32px; max-width:1100px; margin:0 auto; width:100%; }

        /* ─── CARD BOXES ─── */
        .box {
            background:#1e1e1e; border:1px solid #2e2e2e; border-radius:16px;
            overflow:hidden; transition:border-color .3s; margin-bottom:20px;
        }
        .box:hover { border-color:rgba(255,193,7,.3); }
        .box-header {
            padding:16px 22px; border-bottom:1px solid #2a2a2a;
            display:flex; align-items:center; justify-content:space-between;
            background:#222;
        }
        .box-header-left { display:flex; align-items:center; gap:10px; }
        .box-header-left i { color:#FFC107; font-size:16px; }
        .box-header-left h5 { margin:0; font-size:.92rem; font-weight:700; color:#eee; }
        .box-badge {
            font-size:.7rem; font-weight:700; padding:3px 10px; border-radius:50px;
            background:rgba(255,193,7,.12); color:#FFC107; border:1px solid rgba(255,193,7,.25);
        }
        .box-body { padding:20px 22px; }

        /* ─── FILE UPLOAD ─── */
        .upload-zone {
            border:2px dashed #333; border-radius:12px; padding:40px 20px;
            text-align:center; cursor:pointer; transition:all .3s;
            background:#161616; position:relative;
        }
        .upload-zone:hover { border-color:#FFC107; background:#1a1a1a; }
        .upload-zone.dragover { border-color:#FFC107; background:rgba(255,193,7,.05); }
        .upload-icon {
            width:64px; height:64px; border-radius:16px; margin:0 auto 16px;
            background:linear-gradient(135deg,rgba(255,193,7,.12),rgba(255,152,0,.12));
            border:1px solid rgba(255,193,7,.2);
            display:flex; align-items:center; justify-content:center;
            font-size:28px; color:#FFC107;
        }
        .upload-zone h6 { font-size:1rem; font-weight:700; color:#eee; margin-bottom:6px; }
        .upload-zone p { font-size:.82rem; color:#666; margin-bottom:14px; }
        .upload-zone small { font-size:.75rem; color:#555; }
        .file-input { display:none; }
        .btn-browse {
            background:linear-gradient(135deg,#FFC107,#FF9800); color:#121212;
            border:none; padding:9px 24px; border-radius:8px; font-weight:700;
            font-size:.85rem; cursor:pointer; transition:all .25s;
            display:inline-flex; align-items:center; gap:8px;
        }
        .btn-browse:hover { transform:translateY(-2px); box-shadow:0 6px 18px rgba(255,193,7,.35); }

        /* ─── VOICE RECORDING SECTION ─── */
        .recording-section {
            margin-top:24px; padding-top:24px; border-top:1px solid #2a2a2a;
        }
        .recording-controls {
            display:flex; align-items:center; justify-content:center; gap:20px;
            margin-bottom:16px;
        }
        .btn-record {
            width:64px; height:64px; border-radius:50%; border:none;
            background:linear-gradient(135deg,#ff3333,#ff6666); color:white;
            font-size:20px; cursor:pointer; transition:all .3s;
            display:flex; align-items:center; justify-content:center;
            box-shadow:0 6px 20px rgba(255,51,51,.3);
        }
        .btn-record:hover { transform:scale(1.05); box-shadow:0 8px 25px rgba(255,51,51,.4); }
        .btn-record.recording {
            background:linear-gradient(135deg,#ff3333,#ff0000);
            animation:pulse 1.5s infinite;
        }
        .btn-record.stop {
            background:linear-gradient(135deg,#4caf50,#2e7d32);
        }
        @keyframes pulse {
            0% { box-shadow:0 0 0 0 rgba(255,51,51,.7); }
            70% { box-shadow:0 0 0 15px rgba(255,51,51,0); }
            100% { box-shadow:0 0 0 0 rgba(255,51,51,0); }
        }
        .recording-status {
            text-align:center; margin-bottom:12px;
        }
        .recording-status span {
            padding:6px 14px; border-radius:20px; font-size:.8rem; font-weight:600;
            background:rgba(255,51,51,.1); color:#ff3333; border:1px solid rgba(255,51,51,.3);
        }
        .recording-status span.ready { background:rgba(76,175,80,.1); color:#4caf50; border-color:rgba(76,175,80,.3); }
        .recording-timer {
            font-size:1.8rem; font-weight:700; color:#FFC107; text-align:center;
            margin:10px 0;
        }
        .audio-visualizer {
            width:100%; height:60px; margin:16px 0;
            background:#161616; border-radius:8px; overflow:hidden;
        }
        .waveform {
            display:flex; align-items:center; justify-content:center;
            height:100%; gap:3px;
        }
        .waveform-bar {
            width:4px; background:#FFC107; border-radius:2px;
            transition:height .2s;
        }

        /* ─── FILE PREVIEW ─── */
        .file-preview {
            background:#161616; border:1px solid #2a2a2a; border-radius:10px;
            padding:14px 18px; display:flex; align-items:center; gap:14px;
            margin-top:16px;
        }
        .file-icon {
            width:42px; height:42px; min-width:42px; border-radius:10px;
            background:linear-gradient(135deg,#FFC107,#FF9800);
            display:flex; align-items:center; justify-content:center;
            color:#121212; font-size:18px;
        }
        .file-details { flex:1; }
        .file-name { font-size:.88rem; font-weight:700; color:#eee; margin-bottom:3px; }
        .file-meta { font-size:.75rem; color:#666; }
        .btn-remove {
            background:transparent; border:1px solid #3a3a3a; color:#999;
            padding:6px 12px; border-radius:6px; font-size:.75rem; cursor:pointer;
            transition:all .25s;
        }
        .btn-remove:hover { border-color:#ff5722; color:#ff5722; }

        /* ─── BUTTONS ─── */
        .btn-transcribe {
            background:linear-gradient(135deg,#FFC107,#FF9800); color:#121212;
            border:none; padding:11px 28px; border-radius:10px; font-weight:700;
            font-size:.9rem; cursor:pointer; transition:all .25s; display:flex;
            align-items:center; gap:8px; width:100%; justify-content:center;
            margin-top:16px;
        }
        .btn-transcribe:hover { transform:translateY(-2px); box-shadow:0 8px 22px rgba(255,193,7,.35); }
        .btn-transcribe:disabled { opacity:.5; cursor:not-allowed; transform:none; }

        /* ─── OUTPUT TEXTAREA ─── */
        .output-textarea {
            width:100%; background:#161616; border:1px solid #2a2a2a; color:#ddd;
            border-radius:10px; padding:16px; font-size:.9rem; line-height:1.8;
            resize:vertical; min-height:200px; font-family:inherit;
        }
        .output-textarea:focus { outline:none; border-color:#FFC107; }

        /* ─── ACTION BUTTONS ─── */
        .action-btns { display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
        .btn-action {
            background:#2a2a2a; color:#999; border:1px solid #3a3a3a;
            padding:9px 18px; border-radius:8px; font-size:.82rem; font-weight:600;
            cursor:pointer; transition:all .25s; display:flex; align-items:center; gap:8px;
        }
        .btn-action:hover { border-color:#FFC107; color:#FFC107; }
        .btn-action.copied { border-color:#4caf50; color:#4caf50; }

        /* ─── STATS ─── */
        .stats-row { display:flex; gap:14px; margin-top:14px; flex-wrap:wrap; }
        .stat-box {
            background:#161616; border:1px solid #2a2a2a; border-radius:8px;
            padding:10px 16px; display:flex; align-items:center; gap:10px;
        }
        .stat-box i { color:#FFC107; font-size:14px; }
        .stat-box span { font-size:.78rem; color:#888; }
        .stat-box strong { color:#eee; font-size:.85rem; }

        /* ─── TIPS ─── */
        .tips-strip {
            display:flex; gap:12px; margin-top:24px; flex-wrap:wrap;
        }
        .tip-pill {
            background:#1a1a1a; border:1px solid #2e2e2e; border-radius:50px;
            padding:7px 14px; font-size:.76rem; color:#777; display:flex; align-items:center; gap:7px;
        }
        .tip-pill i { color:#FFC107; font-size:11px; }

        /* ─── LOADING ─── */
        .loading-overlay {
            position:fixed; inset:0; background:rgba(0,0,0,.8);
            display:none; align-items:center; justify-content:center; z-index:3000;
        }
        .loading-overlay.active { display:flex; }
        .loading-content {
            background:#222; border:2px solid #FFC107; border-radius:16px;
            padding:32px 48px; text-align:center;
        }
        .spinner {
            width:48px; height:48px; border:4px solid #333;
            border-top-color:#FFC107; border-radius:50%;
            animation:spin 1s linear infinite; margin:0 auto 16px;
        }
        @keyframes spin { to { transform:rotate(360deg); } }
        .loading-content p { color:#aaa; font-size:.9rem; margin:0; }

        /* ─── TOAST ─── */
        .toast-wrap { position:fixed; bottom:28px; right:28px; z-index:2000; }
        .toast-msg {
            background:#222; border:1px solid #FFC107; color:#fff; padding:12px 22px;
            border-radius:10px; font-size:.85rem; font-weight:600; display:flex; align-items:center; gap:10px;
            box-shadow:0 8px 24px rgba(0,0,0,.4); transform:translateY(80px); opacity:0;
            transition:all .35s ease; max-width:320px;
        }
        .toast-msg.show { transform:translateY(0); opacity:1; }
        .toast-msg i { color:#FFC107; font-size:16px; }

        /* ─── FOOTER ─── */
        .dash-footer {
            background:#0a0a0a; border-top:2px solid #FFC107;
            padding:24px 32px; text-align:center; margin-top:auto;
        }
        .dash-footer p { color:#777; font-size:.78rem; margin:2px 0; }
        .dash-footer .f-highlight { color:#FFC107; font-weight:600; }

        /* ─── RESPONSIVE ─── */
        @media(max-width:768px){
            .main-content { padding:24px 18px; }
            .top-navbar { padding:12px 16px; }
            .nb-links { gap:2px; }
            .nb-links a { padding:6px 10px; font-size:12px; }
            .recording-controls { gap:10px; }
        }
        @media(max-width:480px){
            .nb-links { display:none; }
            .page-hero { padding:28px 18px 24px; }
            .page-hero h1 { font-size:1.5rem; }
        }
    </style>
</head>
<body>

<!-- ═══════════ NAVBAR ═══════════ -->
<nav class="top-navbar" id="topNav">
    <div class="nb-left">
        <a href="{{ url_for('dashboard') }}" style="text-decoration:none;display:flex;align-items:center;gap:12px;">
            <div class="nb-logo"><i class="fas fa-robot"></i></div>
            <span class="nb-brand">AI Hub</span>
        </a>
    </div>
    <div class="nb-links">
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
        <a href="{{ url_for('summarize') }}">Summarize</a>
        <a href="{{ url_for('tts') }}">Text to Speech</a>
        <a href="{{ url_for('stt') }}" class="active">Speech to Text</a>
        <a href="{{ url_for('ocr') }}">OCR</a>
        <a href="{{ url_for('profile') }}">Profile</a>
    </div>
    <div class="nb-right">
        <div class="nb-profile">
            <div class="nb-avatar">
                {% if session.profile_image %}
                    <img src="{{ url_for('static', filename='uploads/' + session.profile_image) }}" style="width:100%;height:100%;object-fit:cover;" alt="">
                {% else %}
                    {{ session.user_name[0]|upper }}
                {% endif %}
            </div>
            <div class="nb-user-info">
                <div class="nb-user-name">{{ session.user_name }}</div>
                <div class="nb-user-role">{{ session.user_role }}</div>
            </div>
        </div>
    </div>
</nav>

<div class="page-wrap">

<!-- ═══════════ PAGE HERO ═══════════ -->
<div class="page-hero">
    <div class="hero-icon-wrap"><i class="fas fa-microphone"></i></div>
    <h1>Speech to <span>Text</span></h1>
    <p>Upload audio file or speak directly - AI will transcribe it instantly</p>
</div>

<!-- ═══════════ MAIN CONTENT ═══════════ -->
<div class="main-content">

    <form method="POST" action="{{ url_for('stt') }}" enctype="multipart/form-data" id="sttForm">
        <!-- UPLOAD BOX -->
        <div class="box">
            <div class="box-header">
                <div class="box-header-left">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h5>Upload Audio File</h5>
                </div>
                <span class="box-badge">OPTION 1</span>
            </div>
            <div class="box-body">
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon"><i class="fas fa-file-audio"></i></div>
                    <h6>Drag & Drop Audio File</h6>
                    <p>or click to browse from your device</p>
                    <button type="button" class="btn-browse" onclick="document.getElementById('audioFile').click()">
                        <i class="fas fa-folder-open"></i> Browse Files
                    </button>
                    <input type="file" class="file-input" id="audioFile" name="audio_file" accept="audio/*">
                    <small>Supported: MP3, WAV, M4A, OGG • Max 10MB</small>
                </div>

                <div class="file-preview" id="filePreview" style="display:none;">
                    <div class="file-icon"><i class="fas fa-music"></i></div>
                    <div class="file-details">
                        <div class="file-name" id="fileName">audio.mp3</div>
                        <div class="file-meta" id="fileMeta">2.5 MB • Ready to transcribe</div>
                    </div>
                    <button type="button" class="btn-remove" onclick="removeFile()">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
            </div>
        </div>

        <!-- VOICE RECORDING BOX -->
        <div class="box">
            <div class="box-header">
                <div class="box-header-left">
                    <i class="fas fa-microphone-alt"></i>
                    <h5>Live Voice Recording</h5>
                </div>
                <span class="box-badge" style="background:rgba(255,51,51,.12);color:#ff3333;border-color:rgba(255,51,51,.25);">OPTION 2</span>
            </div>
            <div class="box-body">
                <div class="recording-section">
                    <div class="recording-status">
                         <h6 style="color:#fff;font-size:1.1rem;margin-bottom:10px;">Coming Soon</h6>
                <p style="color:#888;font-size:.85rem;margin-bottom:20px;max-width:400px;margin-left:auto;margin-right:auto;">
                    Real-time voice recording feature will be available in the next update.
                </p>
                
                <div style="background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:15px;margin:20px auto;max-width:300px;">
                    <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px;">
                    </div>
                    
                    <div class="recording-timer" id="recordingTimer">00:00</div>
                    
                    <div class="audio-visualizer">
                        <div class="waveform" id="waveform"></div>
                    </div>
                    
                    <div class="recording-controls">
                        <button type="button" class="btn-record" id="recordBtn" onclick="toggleRecording()">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    
                    <div style="text-align:center;margin-top:12px;">
                        <p style="font-size:.8rem;color:#666;">
                            <i class="fas fa-info-circle"></i> Click the mic to start/stop recording
                        </p>
                    </div>
                    
                    <!-- Hidden input to store recorded audio -->
                    <input type="hidden" id="recordedAudio" name="recorded_audio">
                </div>
            </div>
        </div>

        <!-- TRANSCRIBE BUTTON -->
        <button type="submit" class="btn-transcribe" id="btnTranscribe" disabled>
            <i class="fas fa-wand-magic-sparkles"></i> Transcribe Audio
        </button>
    </form>

    <!-- OUTPUT BOX -->
    {% if extracted_text %}
    <div class="box">
        <div class="box-header">
            <div class="box-header-left">
                <i class="fas fa-check-circle" style="color:#4caf50;"></i>
                <h5>Transcribed Text</h5>
            </div>
            <span class="box-badge" style="background:rgba(76,175,80,.12);color:#4caf50;border-color:rgba(76,175,80,.25);">READY</span>
        </div>
        <div class="box-body">
            <textarea class="output-textarea" id="outputText" readonly>{{ extracted_text }}</textarea>
            <div class="action-btns">
                <button type="button" class="btn-action" id="copyBtn" onclick="copyText()">
                    <i class="fas fa-copy"></i> Copy Text
                </button>
                <button type="button" class="btn-action" onclick="downloadText()">
                    <i class="fas fa-download"></i> Download as TXT
                </button>
            </div>
            <div class="stats-row">
                <div class="stat-box">
                    <i class="fas fa-font"></i>
                    <span>Words: <strong>{{ extracted_text.split()|length }}</strong></span>
                </div>
                <div class="stat-box">
                    <i class="fas fa-file-alt"></i>
                    <span>Characters: <strong>{{ extracted_text|length }}</strong></span>
                </div>
                <div class="stat-box">
                    <i class="fas fa-language"></i>
                    <span>Language: <strong>English</strong></span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- TIPS -->
    <div class="tips-strip">
        <div class="tip-pill"><i class="fas fa-check"></i> Clear audio works best</div>
        <div class="tip-pill"><i class="fas fa-check"></i> Supports multiple formats</div>
        <div class="tip-pill"><i class="fas fa-check"></i> Accurate transcription</div>
        <div class="tip-pill"><i class="fas fa-check"></i> Auto language detection</div>
        <div class="tip-pill"><i class="fas fa-check"></i> Real-time recording</div>
    </div>
</div>

</div><!-- end page-wrap -->

<!-- ═══════════ FOOTER ═══════════ -->
<footer class="dash-footer">
    <p><span class="f-highlight">© 2025 AI-Powered Content Transformation Hub</span></p>
    <p>Savitribai Phule Pune University</p>
</footer>

<!-- ═══════════ LOADING OVERLAY ═══════════ -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <p id="loadingText">Transcribing audio...</p>
    </div>
</div>

<!-- ═══════════ TOAST ═══════════ -->
<div class="toast-wrap">
    <div class="toast-msg" id="toast"><i class="fas fa-check-circle"></i> <span id="toastText">Success!</span></div>
</div>

<script>
// ─── Voice Recording Variables ───
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let recordingTime = 0;
let timerInterval = null;
let audioContext = null;
let analyser = null;
let microphone = null;

// ─── File input handling ───
const fileInput = document.getElementById('audioFile');
const uploadZone = document.getElementById('uploadZone');
const filePreview = document.getElementById('filePreview');
const btnTranscribe = document.getElementById('btnTranscribe');
const form = document.getElementById('sttForm');
const recordBtn = document.getElementById('recordBtn');
const recordingStatus = document.getElementById('recordingStatus');
const recordingTimer = document.getElementById('recordingTimer');

// Initialize waveform
initializeWaveform();

fileInput.addEventListener('change', handleFile);

uploadZone.addEventListener('click', (e) => {
    if (e.target.tagName !== 'BUTTON') fileInput.click();
});

// Drag & drop
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFile();
    }
});

function handleFile() {
    const file = fileInput.files[0];
    if (!file) return;

    // Show preview
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileMeta').textContent = formatFileSize(file.size) + ' • Ready to transcribe';
    uploadZone.style.display = 'none';
    filePreview.style.display = 'flex';
    enableTranscribeButton();
}

function removeFile() {
    fileInput.value = '';
    uploadZone.style.display = 'block';
    filePreview.style.display = 'none';
    disableTranscribeButton();
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
}

// ─── Voice Recording Functions ───
async function toggleRecording() {
    if (!isRecording) {
        startRecording();
    } else {
        stopRecording();
    }
}

async function startRecording() {
    try {
        // Reset previous recording
        audioChunks = [];
        recordingTime = 0;
        
        // Request microphone access
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Setup MediaRecorder
        mediaRecorder = new MediaRecorder(stream);
        
        // Setup audio visualization
        setupAudioVisualization(stream);
        
        // Handle data
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
            }
        };
        
        // Handle stop
        mediaRecorder.onstop = async () => {
            // Convert audio chunks to base64
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            
            reader.onloadend = () => {
                const base64data = reader.result;
                document.getElementById('recordedAudio').value = base64data;
                
                // Enable transcription button
                enableTranscribeButton();
                
                // Show file preview
                showRecordedAudioPreview();
            };
            
            reader.readAsDataURL(audioBlob);
            
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
            
            // Clean up audio context
            if (audioContext) {
                await audioContext.close();
            }
        };
        
        // Start recording
        mediaRecorder.start();
        isRecording = true;
        
        // Update UI
        recordBtn.classList.add('recording');
        recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
        recordingStatus.textContent = 'Recording...';
        recordingStatus.classList.remove('ready');
        
        // Start timer
        startTimer();
        
        // Show toast
        showToast('Recording started. Speak now...');
        
    } catch (error) {
        console.error('Recording error:', error);
        showToast('Error accessing microphone. Please check permissions.');
    }
}

function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        
        // Update UI
        recordBtn.classList.remove('recording');
        recordBtn.classList.add('stop');
        setTimeout(() => recordBtn.classList.remove('stop'), 500);
        recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        recordingStatus.textContent = 'Recording saved';
        recordingStatus.classList.add('ready');
        
        // Stop timer
        stopTimer();
        
        // Clear waveform
        clearWaveform();
        
        // Show toast
        showToast('Recording stopped. Ready to transcribe.');
    }
}

function startTimer() {
    recordingTimer.textContent = '00:00';
    recordingTime = 0;
    timerInterval = setInterval(() => {
        recordingTime++;
        const minutes = Math.floor(recordingTime / 60).toString().padStart(2, '0');
        const seconds = (recordingTime % 60).toString().padStart(2, '0');
        recordingTimer.textContent = `${minutes}:${seconds}`;
        
        // Auto-stop after 2 minutes
        if (recordingTime >= 120) {
            stopRecording();
        }
    }, 1000);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

function initializeWaveform() {
    const waveform = document.getElementById('waveform');
    waveform.innerHTML = '';
    for (let i = 0; i < 40; i++) {
        const bar = document.createElement('div');
        bar.className = 'waveform-bar';
        bar.style.height = '10px';
        waveform.appendChild(bar);
    }
}

function setupAudioVisualization(stream) {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(stream);
        
        analyser.fftSize = 256;
        microphone.connect(analyser);
        
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        function updateWaveform() {
            if (!isRecording) return;
            
            requestAnimationFrame(updateWaveform);
            analyser.getByteFrequencyData(dataArray);
            
            const bars = document.querySelectorAll('.waveform-bar');
            const step = Math.floor(bufferLength / bars.length);
            
            bars.forEach((bar, i) => {
                const value = dataArray[i * step] / 2;
                bar.style.height = Math.max(10, value) + 'px';
                bar.style.opacity = Math.max(0.3, value / 100);
            });
        }
        
        updateWaveform();
    } catch (error) {
        console.error('Visualization error:', error);
    }
}

function clearWaveform() {
    const bars = document.querySelectorAll('.waveform-bar');
    bars.forEach(bar => {
        bar.style.height = '10px';
        bar.style.opacity = '0.3';
    });
}

function showRecordedAudioPreview() {
    // If file preview is not showing (no file uploaded), show recording preview
    if (filePreview.style.display === 'none') {
        document.getElementById('fileName').textContent = 'voice_recording.webm';
        document.getElementById('fileMeta').textContent = 'Voice recording • Ready to transcribe';
        filePreview.style.display = 'flex';
    }
}

function enableTranscribeButton() {
    btnTranscribe.disabled = false;
    document.getElementById('loadingText').textContent = 'Transcribing audio...';
}

function disableTranscribeButton() {
    // Only disable if no recorded audio either
    if (!document.getElementById('recordedAudio').value) {
        btnTranscribe.disabled = true;
    }
}

// ─── Form submission ───
form.addEventListener('submit', function(e) {
    const hasFile = fileInput.files.length > 0;
    const hasRecording = document.getElementById('recordedAudio').value;
    
    if (!hasFile && !hasRecording) {
        e.preventDefault();
        showToast('Please upload an audio file or record your voice first.');
        return;
    }
    
    document.getElementById('loadingOverlay').classList.add('active');
});

// ─── Copy text ───
function copyText() {
    const out = document.getElementById('outputText');
    if (!out) return;
    out.select();
    document.execCommand('copy');
    const btn = document.getElementById('copyBtn');
    btn.classList.add('copied');
    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
    setTimeout(() => {
        btn.classList.remove('copied');
        btn.innerHTML = '<i class="fas fa-copy"></i> Copy Text';
    }, 1800);
    showToast('Text copied to clipboard!');
}

// ─── Download text ───
function downloadText() {
    const text = document.getElementById('outputText').value;
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'transcription.txt';
    a.click();
    URL.revokeObjectURL(url);
    showToast('File downloaded!');
}

// ─── Toast ───
function showToast(msg) {
    const t = document.getElementById('toast');
    document.getElementById('toastText').textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2200);
}

// {% if extracted_text %}
//     setTimeout(() => showToast('Transcription completed!'), 300);
// {% endif %}

// ─── Navbar scroll ───
const topNav = document.getElementById('topNav');
window.addEventListener('scroll', () => { topNav.classList.toggle('scrolled', window.scrollY > 40); });
</script>
</body>
</html>